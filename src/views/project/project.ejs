<%- include('../partials/header', {title: project.name + ' | TaskWave'}); %>

<main>
  <!-- Project Header -->
  <div class="bg-primary bg-opacity-10 py-4">
    <div class="container">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="mb-3 mb-md-0">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
              <li class="breadcrumb-item active" aria-current="page"><%= project.name %></li>
            </ol>
          </nav>
          <h1 class="h2 mb-0 fw-bold"><%= project.name %></h1>
          <p class="text-muted mb-0"><%= project.description || 'No description' %></p>
        </div>
        <div class="d-flex gap-2">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="fas fa-cog me-1"></i> Project Settings
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProjectModal">
                <i class="fas fa-pencil-alt me-2"></i>Edit Project
              </a></li>
              <li><a class="dropdown-item" href="#">
                <i class="fas fa-users me-2"></i>Manage Team
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#">
                <i class="fas fa-trash me-2"></i>Delete Project
              </a></li>
            </ul>
          </div>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
            <i class="fas fa-plus me-1"></i> New Task
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Stats -->
  <div class="border-bottom py-3">
    <div class="container">
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-10 p-2 rounded me-3">
              <i class="fas fa-tasks text-primary"></i>
            </div>
            <div>
              <h6 class="mb-0">Total Tasks</h6>
              <p class="mb-0 fw-bold"><%= project.taskCount || 0 %></p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="d-flex align-items-center">
            <div class="bg-success bg-opacity-10 p-2 rounded me-3">
              <i class="fas fa-check-circle text-success"></i>
            </div>
            <div>
              <h6 class="mb-0">Completed</h6>
              <p class="mb-0 fw-bold"><%= project.completedTasks || 0 %></p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="d-flex align-items-center">
            <div class="bg-warning bg-opacity-10 p-2 rounded me-3">
              <i class="fas fa-clock text-warning"></i>
            </div>
            <div>
              <h6 class="mb-0">Due Soon</h6>
              <p class="mb-0 fw-bold"><%= project.dueSoonTasks || 0 %></p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="d-flex align-items-center">
            <div class="bg-danger bg-opacity-10 p-2 rounded me-3">
              <i class="fas fa-exclamation-circle text-danger"></i>
            </div>
            <div>
              <h6 class="mb-0">Overdue</h6>
              <p class="mb-0 fw-bold"><%= project.overdueTasks || 0 %></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Content -->
  <div class="container py-4">
    <!-- Kanban Board -->
    <div class="kanban-board">
      <div class="row g-3">
        <!-- To Do Column -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">To Do</h5>
              <span class="badge bg-primary"><%= project.columns.todo.tasks.length %></span>
            </div>
            <div class="card-body p-3" id="todo-column">
              <% project.columns.todo.tasks.forEach(task => { %>
                <%- include('../partials/task-card', {task: task}); %>
              <% }); %>
              <div class="text-center mt-2">
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="addTask('todo')">
                  <i class="fas fa-plus me-1"></i> Add Task
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- In Progress Column -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">In Progress</h5>
              <span class="badge bg-warning text-dark"><%= project.columns.inProgress.tasks.length %></span>
            </div>
            <div class="card-body p-3" id="inProgress-column">
              <% project.columns.inProgress.tasks.forEach(task => { %>
                <%- include('../partials/task-card', {task: task}); %>
              <% }); %>
              <div class="text-center mt-2">
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="addTask('inProgress')">
                  <i class="fas fa-plus me-1"></i> Add Task
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Done Column -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">Done</h5>
              <span class="badge bg-success"><%= project.columns.done.tasks.length %></span>
            </div>
            <div class="card-body p-3" id="done-column">
              <% project.columns.done.tasks.forEach(task => { %>
                <%- include('../partials/task-card', {task: task}); %>
              <% }); %>
              <div class="text-center mt-2">
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="addTask('done')">
                  <i class="fas fa-plus me-1"></i> Add Task
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Project Team -->
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-header bg-white border-0">
        <h5 class="mb-0 fw-bold">Project Team</h5>
      </div>
      <div class="card-body">
        <div class="avatar-group">
          <% project.team.forEach(member => { %>
            <div class="avatar avatar-lg position-relative" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= member.name %> (<%= member.role %>)">
              <img src="<%= member.avatar %>" class="rounded-circle" alt="<%= member.name %>">
              <% if (member.isOnline) { %>
                <span class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-white" style="width: 12px; height: 12px;"></span>
              <% } %>
            </div>
          <% }); %>
          <button class="btn btn-sm btn-outline-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-header bg-white border-0">
        <h5 class="mb-0 fw-bold">Recent Activity</h5>
      </div>
      <div class="card-body">
        <div class="activity-feed">
          <% project.activity.forEach(activity => { %>
            <div class="activity-item d-flex mb-3">
              <div class="flex-shrink-0">
                <img src="<%= activity.user.avatar %>" class="rounded-circle" width="40" height="40" alt="<%= activity.user.name %>">
              </div>
              <div class="flex-grow-1 ms-3">
                <div class="d-flex justify-content-between">
                  <h6 class="mb-0 fw-bold"><%= activity.user.name %></h6>
                  <small class="text-muted"><%= activity.time %></small>
                </div>
                <p class="mb-0"><%= activity.message %></p>
                <% if (activity.task) { %>
                  <small class="text-muted">Task: <a href="#"><%= activity.task %></a></small>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newTaskForm">
          <div class="row g-3">
            <div class="col-md-12">
              <label for="taskTitle" class="form-label">Task Title</label>
              <input type="text" class="form-control" id="taskTitle" required>
            </div>
            <div class="col-md-12">
              <label for="taskDescription" class="form-label">Description</label>
              <textarea class="form-control" id="taskDescription" rows="3"></textarea>
            </div>
            <div class="col-md-6">
              <label for="taskDueDate" class="form-label">Due Date</label>
              <input type="date" class="form-control" id="taskDueDate">
            </div>
            <div class="col-md-6">
              <label for="taskPriority" class="form-label">Priority</label>
              <select class="form-select" id="taskPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-12">
              <label for="taskAssignee" class="form-label">Assign To</label>
              <select class="form-select" id="taskAssignee">
                <option value="">Unassigned</option>
                <% project.team.forEach(member => { %>
                  <option value="<%= member.id %>"><%= member.name %></option>
                <% }); %>
              </select>
            </div>
            <div class="col-md-12">
              <label for="taskLabels" class="form-label">Labels</label>
              <select class="form-select" id="taskLabels" multiple>
                <option value="design">Design</option>
                <option value="development">Development</option>
                <option value="bug">Bug</option>
                <option value="feature">Feature</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createTask()">Create Task</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editProjectForm">
          <div class="mb-3">
            <label for="editProjectName" class="form-label">Project Name</label>
            <input type="text" class="form-control" id="editProjectName" value="<%= project.name %>" required>
          </div>
          <div class="mb-3">
            <label for="editProjectDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editProjectDescription" rows="3"><%= project.description %></textarea>
          </div>
          <div class="mb-3">
            <label for="editProjectStatus" class="form-label">Status</label>
            <select class="form-select" id="editProjectStatus">
              <option value="active" <%= project.status === 'active' ? 'selected' : '' %>>Active</option>
              <option value="on-hold" <%= project.status === 'on-hold' ? 'selected' : '' %>>On Hold</option>
              <option value="completed" <%= project.status === 'completed' ? 'selected' : '' %>>Completed</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateProject()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer'); %>

<!-- Drag and Drop JS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
  // Initialize tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initialize SortableJS for drag and drop
    new Sortable(document.getElementById('todo-column'), {
      group: 'tasks',
      animation: 150,
      onEnd: function(evt) {
        updateTaskStatus(evt.item.dataset.taskId, 'todo');
      }
    });

    new Sortable(document.getElementById('inProgress-column'), {
      group: 'tasks',
      animation: 150,
      onEnd: function(evt) {
        updateTaskStatus(evt.item.dataset.taskId, 'inProgress');
      }
    });

    new Sortable(document.getElementById('done-column'), {
      group: 'tasks',
      animation: 150,
      onEnd: function(evt) {
        updateTaskStatus(evt.item.dataset.taskId, 'done');
      }
    });
  });

  function addTask(column) {
    // Set the default column in the form
    document.getElementById('newTaskForm').dataset.column = column;
    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById('newTaskModal'));
    modal.show();
  }

  function createTask() {
    // Get form data and create task via AJAX
    const form = document.getElementById('newTaskForm');
    const column = form.dataset.column;
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    
    // Here you would make an AJAX call to your backend
    console.log('Creating task in column:', column);
    
    // Close modal
    var modal = bootstrap.Modal.getInstance(document.getElementById('newTaskModal'));
    modal.hide();
    
    // Reset form
    form.reset();
  }

  function updateTaskStatus(taskId, newStatus) {
    // Make AJAX call to update task status
    console.log(`Moving task ${taskId} to ${newStatus}`);
    // fetch(`/api/tasks/${taskId}/status`, {
    //   method: 'PUT',
    //   body: JSON.stringify({ status: newStatus }),
    //   headers: { 'Content-Type': 'application/json' }
    // });
  }

  function updateProject() {
    // Get form data and update project via AJAX
    const name = document.getElementById('editProjectName').value;
    const description = document.getElementById('editProjectDescription').value;
    const status = document.getElementById('editProjectStatus').value;
    
    // Here you would make an AJAX call to your backend
    console.log('Updating project:', { name, description, status });
    
    // Close modal
    var modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
    modal.hide();
  }
</script>